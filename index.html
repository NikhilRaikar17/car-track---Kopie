<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R1-CarCare</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
	<link rel="manifest" href="manifest.json">
	<link rel="stylesheet" href="style.css">
</head>	

<body>
	<div class="container mt-4">

		<div class="text-center mb-4">
			<h2>R1-CarCare</h2>
			<h2>Vehicle Tracker</h2>
		</div>

		<ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="vehicleFormTab-tab" data-bs-toggle="tab" data-bs-target="#vehicleFormTab" type="button" role="tab" aria-controls="vehicleForm" aria-selected="true">Vehicle Form</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="searchVehicleTab-tab" data-bs-toggle="tab" data-bs-target="#searchVehicleTab" type="button" role="tab" aria-controls="searchVehicle" aria-selected="false">Search Vehicle</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="todaysCountTab-tab" data-bs-toggle="tab" data-bs-target="#todaysCountTab" type="button" role="tab" aria-controls="todaysCount" aria-selected="false">Today's Count</button>
            </li>
        </ul>

		<div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="vehicleFormTab" role="tabpanel" aria-labelledby="vehicleFormTab-tab">
                <!-- Vehicle Form Goes Here -->
                <form id="vehicleForm">
					<div class="mb-3">
						<input type="text" id="name" class="form-control" placeholder="Enter Name">
					</div>
					<div class="mb-3">
						<input type="text" id="vehicleNumber" class="form-control" placeholder="Enter Vehicle Number">
					</div>
					<div class="mb-3">
						<input type="tel" id="phoneNumber" class="form-control" placeholder="Enter Phone Number">
					</div>
					<div class="mb-3">
						<input type="text" id="amount" class="form-control" placeholder="Enter amount">
					</div>
					<div class="mb-3">
						<select id="subscriber" name="subscriber" class="form-select" required>
							<option value="" selected disabled>Subscribed?</option>
							<option value="yes">Yes</option>
							<option value="no">No</option>
						</select>
					</div>
				
					<div id="subscriptionDetails" style="display:none;">
						<div class="mb-3">
							<input type="number" id="quickWashes" name="quickWashes" class="form-control" placeholder="Enter remaining Quick Washes">
						</div>
						<div class="mb-3">
							<input type="number" id="normalWashes" name="normalWashes" class="form-control" placeholder="Enter remaining Normal Washes">
						</div>
					</div>
		
					<div class="mb-3">
						<input type="date" id="date" class="form-control" placeholder="Select Date">
					</div>
					<div class="mb-3"><input type="time" id="time" class="form-control" placeholder="Select Time"></div>
					
					<button type="submit" id="recordVehicleButton" class="btn btn-primary">Record Vehicle</button>
				</form>
            </div>

			<div id="searchVehicleTab" class="tab-pane fade" role="tabpanel" aria-labelledby="searchVehicle-tab">
				<div class="mt-3">
					<!-- Search Type Selection -->
					<div class="mb-3">
						<select id="searchType" class="form-select">
							<option value="vehicleNumber">Vehicle Number</option>
							<option value="phoneNumber">Phone Number</option>
						</select>
					</div>
					<!-- Search Query Input -->
					<input type="text" id="searchQuery" class="form-control mb-3" placeholder="Enter search query">
					<!-- Search Button -->
					<button id="searchSubmitButton" type="button" class="btn btn-primary mb-3">Search</button>
					<!-- Search Results Display -->
					<div id="searchResults"></div>
				</div>
			</div>


			<div class="tab-pane fade" id="todaysCountTab" role="tabpanel" aria-labelledby="todaysCountTab-tab">

                <div id="todaysRecords">
                    <h3>Today's Records</h3>
                    <div id="recordsList" class="mt-3"></div>
                </div>
            </div>
        </div>	
		
		<button id="installButton" style="display: none;" class="btn btn-info mt-3">Install App</button>
		<div id="message" class="mt-3 text-success"></div>
		
	</div>

	<!-- Include Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js'

		// If you enabled Analytics in your project, add the Firebase SDK for Google Analytics
		import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-analytics.js'

		// Add Firebase products that you want to use
		import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js'
		import { getFirestore, collection, getDocs, addDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js'

		const firebaseConfig = {
			apiKey: "AIzaSyDu-W8ET-1eCppfmaYq0YZMqR5hfzs9tsU",
			authDomain: "r1carcare.firebaseapp.com",
			projectId: "r1carcare",
			storageBucket: "r1carcare.appspot.com",
			messagingSenderId: "781639349911",
			appId: "1:781639349911:web:56d9904353a8abddd4dbd2",
			measurementId: "G-SRFE2K96P9"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		// Make db available to the window object
		window.db = db;
		
		document.addEventListener('DOMContentLoaded', function() {

			const subscriberSelect = document.getElementById('subscriber');

			document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
				e.preventDefault();

				// Extract form values
				const vehicleNumber = document.getElementById('vehicleNumber').value;
				const name = document.getElementById('name').value;
				const phoneNumber = document.getElementById('phoneNumber').value;
				const amount = document.getElementById('amount').value;
				const subscriber = document.getElementById('subscriber').value === 'yes';
				const date = document.getElementById('date').value;
				const time = document.getElementById('time').value;
				const dateTime = `${date} ${time}`;
				const quickWashes = subscriber ? document.getElementById('quickWashes').value : 0;
				const normalWashes = subscriber ? document.getElementById('normalWashes').value : 0;

				const messageDiv = document.getElementById('message');

				// Define Firestore reference
				const vehiclesRef = collection(window.db, "vehicles");
				const q = query(vehiclesRef, where("vehicle_number", "==", vehicleNumber));

				try {
					const querySnapshot = await getDocs(q);
					if (querySnapshot.empty) {
						// Record doesn't exist, proceed to add
						await addDoc(vehiclesRef, {
							vehicle_number: vehicleNumber,
							name: name,
							phone_number: phoneNumber,
							amount: amount,
							subscriber: subscriber,
							date: dateTime,
							quickWashes: quickWashes,
							normalWashes: normalWashes,
						});
						console.log("Document written with ID: ", vehicleNumber);
						messageDiv.textContent = 'Vehicle Recorded Successfully!';
						messageDiv.style.color = 'green';
					} else {
						// Vehicle number exists
						messageDiv.textContent = 'Vehicle number already exists in database.';
						messageDiv.style.color = 'red';
					}
				} catch (error) {
					console.error("Error adding document: ", error);
					messageDiv.textContent = 'Error recording vehicle: ' + error.message;
					messageDiv.style.color = 'red';
				}

				// Reset form and clear message after 2 seconds
				document.getElementById('vehicleForm').reset();
				setTimeout(() => {
					messageDiv.textContent = '';
				}, 2000);
			});


		});

		document.getElementById('subscriber').addEventListener('change', function() {
			const subscriptionDetails = document.getElementById('subscriptionDetails');
			if (this.value === 'yes') {
				subscriptionDetails.style.display = 'block';
			} else {
				subscriptionDetails.style.display = 'none';
			}
		});

		// search code to search vehicles
		document.getElementById('searchSubmitButton').addEventListener('click', async () => {
			const searchType = document.getElementById('searchType').value;
			const searchQuery = document.getElementById('searchQuery').value.trim();
			const searchResultsDiv = document.getElementById('searchResults');
			searchResultsDiv.innerHTML = ''; // Clear previous results

			// Validate search query
			if (!searchQuery) {
				searchResultsDiv.textContent = 'Please enter a search query.';
				return;
			}

			// Firestore query
			const queryField = searchType === 'vehicleNumber' ? 'vehicle_number' : 'phone_number';
			try {
				const q = query(collection(db, "vehicles"), where(queryField, "==", searchQuery));
				const querySnapshot = await getDocs(q);

				if (querySnapshot.empty) {
					searchResultsDiv.textContent = 'No results found.';
				} else {
					// Create a table for the results
					const table = document.createElement('table');
					table.className = 'table table-bordered'; // Bootstrap classes for styling
					const thead = document.createElement('thead');
					const tbody = document.createElement('tbody');

					// Define table headers
					const headers = ['Name', 'Vehicle Number', 'Phone Number', 'Subscriber', 'Last Washed', 'Remaining Quick washe', 'Remaining normal wash' ];
					const dataAttributes = ['name', 'vehicle_number', 'phone_number', 'subscriber', 'date', 'quickWashes', 'normalWashes'];

					// Create table structure
					table.className = 'table table-bordered'; // Bootstrap classes for styling
					table.appendChild(thead);
					table.appendChild(tbody);

					// Transpose: Creating a row for each header
					headers.forEach((header, index) => {
						const row = tbody.insertRow();
						const headerCell = document.createElement('th');
						headerCell.textContent = header;
						row.appendChild(headerCell);

						querySnapshot.forEach(doc => {
							const vehicle = doc.data();
							const cell = document.createElement('td');
							// Handling the 'subscriber' field to display 'Yes' or 'No'
							if (dataAttributes[index] === 'subscriber') {
								cell.textContent = vehicle[dataAttributes[index]] ? 'Yes' : 'No';
							} else {
								cell.textContent = vehicle[dataAttributes[index]] || 'N/A';
							}
							row.appendChild(cell);
						});
					});
					table.appendChild(tbody);
					searchResultsDiv.appendChild(table);
				}
			} catch (error) {
				console.error("Error performing search:", error);
				searchResultsDiv.textContent = 'Error performing search.';
			}
		});




		document.getElementById('todaysCountTab-tab').addEventListener('click', async () => {
			const recordsListDiv = document.getElementById('recordsList');
			recordsListDiv.innerHTML = ''; // Clear previous content

			// Create a table
			const table = document.createElement('table');
			table.className = 'table table-striped'; // Bootstrap class for styling
			const thead = document.createElement('thead');
			const tbody = document.createElement('tbody');
			table.appendChild(thead);
			table.appendChild(tbody);

			// Table headers
			

			const today = new Date();
			const dayStart = new Date(today.setHours(0, 0, 0, 0)).toISOString().split('T')[0] + " 00:00";
			const dayEnd = new Date(today.setHours(23, 59, 59, 999)).toISOString().split('T')[0] + " 23:59";

			// Adjust the query as needed based on your date storage format
			const q = query(collection(window.db, "vehicles"), where("date", ">=", dayStart), where("date", "<=", dayEnd));

			try {
				const querySnapshot = await getDocs(q);
				if (querySnapshot.empty) {
					recordsListDiv.textContent = 'No vehicles recorded today.';
				} else {
					let count = 0;
					let totalIncome = 0;

					const headerRow = document.createElement('tr');
					['No.', 'Vehicle Number', 'Name', 'Phone Number', 'Date'].forEach(text => {
						const headerCell = document.createElement('th');
						headerCell.textContent = text;
						headerRow.appendChild(headerCell);
					});
					thead.appendChild(headerRow);

					querySnapshot.forEach(doc => {
						count++;
						const data = doc.data();
						const row = tbody.insertRow();
						const numberCell = row.insertCell();
						const vehicleNumberCell = row.insertCell();
						const nameCell = row.insertCell();
						const phoneCell = row.insertCell();
						const dateTimeCell = row.insertCell();

						numberCell.textContent = count;
						vehicleNumberCell.textContent = data.vehicle_number;
						nameCell.textContent = data.name;
						phoneCell.textContent = data.phone_number;
						dateTimeCell.textContent = data.date;
						});
						recordsListDiv.appendChild(table);

						// Display the final count
						const countDisplay = document.createElement('div');
						countDisplay.className = 'mt-3'; // Bootstrap margin top class
						countDisplay.textContent = `Total records for today: ${count}`;
						recordsListDiv.appendChild(countDisplay);
					}			

			} catch (error) {
				console.error("Error fetching documents: ", error);
			}
		});

	</script>

	<script>
		if ('serviceWorker' in navigator) {
		window.addEventListener('load', () => {
			navigator.serviceWorker.register('/service-worker.js')
			.then(reg => console.log('Service Worker Registered', reg))
			.catch(err => console.log('Service Worker Registration Failed', err));
		});
		}
	</script>
</body>

</html>
