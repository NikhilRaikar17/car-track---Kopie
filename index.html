<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R1-CarCare</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
	<link rel="manifest" href="manifest.json">
</head>	

<body>
	<div class="container mt-4">

		<div class="text-center mb-4">
			<h2>R1-CarCare</h2>
			<h2>Vehicle Tracker</h2>
		</div>
	
		<div id="todayVehicleCount" style="margin-bottom: 15px;">Today's recorded vehicles: 0</div>
	
		<form id="vehicleForm">
			<div class="mb-3">
				<input type="text" id="name" class="form-control" placeholder="Enter Name">
			</div>
			<div class="mb-3">
				<input type="text" id="vehicleNumber" class="form-control" placeholder="Enter Vehicle Number">
			</div>
			<div class="mb-3">
				<input type="tel" id="phoneNumber" class="form-control" placeholder="Enter Phone Number">
			</div>
			<div class="mb-3">
				<input type="text" id="amount" class="form-control" placeholder="Enter amount">
			</div>
			<div class="mb-3">
				<select id="subscriber" name="subscriber" class="form-select" required>
					<option value="" selected disabled>Subscribed?</option>
					<option value="yes">Yes</option>
					<option value="no">No</option>
				</select>
			</div>
		
			<div class="mb-3" id="washTypePlaceholder"></div>

			<div class="mb-3">
				<input type="date" id="date" class="form-control" placeholder="Select Date">
			</div>
			<div class="mb-3"><input type="time" id="time" class="form-control" placeholder="Select Time"></div>

			
			<button type="submit" id="recordVehicleButton" class="btn btn-primary">Record Vehicle</button>
		</form>
			
		<button id="searchPageButton" type="button" class="btn btn-secondary mt-3" >Search Vehicle</button>
	
		<div id="searchVehicleForm" style="display:none;" class="mt-3">
			<input type="text" id="searchVehicleNumber" class="form-control" placeholder="Enter Vehicle Number">
			<div id="searchResults" class="mt-3"></div>
			<button id="searchSubmitButton" type="button" class="btn btn-primary mt-3">Submit</button>
			<button id="goBackButton" type="button" class="btn btn-secondary mt-3">Go Back</button>	
		</div>
		
		<button id="installButton" style="display: none;" class="btn btn-info mt-3">Install App</button>
		<div id="message" class="mt-3 text-success"></div>
		
	</div>

	<!-- Include Bootstrap Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js'

		// If you enabled Analytics in your project, add the Firebase SDK for Google Analytics
		import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-analytics.js'

		// Add Firebase products that you want to use
		import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js'
		import { getFirestore, collection, getDocs, addDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js'

		const firebaseConfig = {
			apiKey: "AIzaSyDu-W8ET-1eCppfmaYq0YZMqR5hfzs9tsU",
			authDomain: "r1carcare.firebaseapp.com",
			projectId: "r1carcare",
			storageBucket: "r1carcare.appspot.com",
			messagingSenderId: "781639349911",
			appId: "1:781639349911:web:56d9904353a8abddd4dbd2",
			measurementId: "G-SRFE2K96P9"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		// Make db available to the window object
		window.db = db;
		
		document.addEventListener('DOMContentLoaded', function() {
			updateVehicleCountDisplay();

			const subscriberSelect = document.getElementById('subscriber');
			const washTypePlaceholder = document.getElementById('washTypePlaceholder');

			subscriberSelect.addEventListener('change', function() {
				// Remove existing wash type select box if it exists
				const existingWashTypeSelect = document.getElementById('washType');
				if (existingWashTypeSelect) existingWashTypeSelect.remove();

				// Dynamically create and add the wash type select box if "Yes" is selected
				if (subscriberSelect.value === 'yes') { 
					const washTypeSelect = document.createElement('select');
					washTypeSelect.id = 'washType';
					washTypeSelect.name = 'washType';
					washTypeSelect.className= "form-select";

					const options = [
						{value: '', text: 'Select Wash Type'},
						{value: 'quick', text: 'Quick Wash'},
						{value: 'normal', text: 'Normal Wash'},
					];

					// Create and append options to the select element
					options.forEach(opt => {
						const optionElement = document.createElement('option');
						optionElement.value = opt.value;
						optionElement.textContent = opt.text;
						washTypeSelect.appendChild(optionElement);
					});

					// Append the newly created select box to the placeholder span
					washTypePlaceholder.appendChild(washTypeSelect);

				} else if (subscriberSelect.value === 'no') {
					// If "No" is selected, ensure any existing select box is removed
					// This step is already covered by removing the select at the start
				}
			});

			document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
				e.preventDefault();

				const vehicleNumber = document.getElementById('vehicleNumber').value;
				const name = document.getElementById('name').value;
				const phoneNumber = document.getElementById('phoneNumber').value;
				const amount = document.getElementById('amount').value;
				const subscriber_value = document.getElementById('subscriber').value;
				const subscriber = subscriber_value === 'yes';1
				const date = document.getElementById('date').value;
				const time = document.getElementById('time').value;
				const dateTime = date + ' ' + time;
				const messageDiv = document.getElementById('message');

				const vehiclesRef = collection(db, "vehicles");
				const q = query(vehiclesRef, where("vehicle_number", "==", vehicleNumber));
				try {
					const querySnapshot = await getDocs(q);
					if (querySnapshot.empty) {
						
						const docRef = await addDoc(collection(window.db, "vehicles"), {
							vehicle_number: vehicleNumber,
							name: name,
							phone_number: phoneNumber,
							amount: amount,
							subscriber: subscriber,
							date: dateTime
						});
						console.log("Document written with vehicle number: ", vehicleNumber);
						messageDiv.textContent = 'Vehicle Recorded Successfully!';
						messageDiv.style.color = 'green';
						document.getElementById('vehicleForm').reset();
						setTimeout(function() {
							messageDiv.textContent = '';
						}, 2000);
						incrementVehicleCount();
					} else {
						console.error("Error recording vehicle: ", error);
						messageDiv.textContent = 'Error recording vehicle: ' + error.message;
						messageDiv.style.color = 'red';
						setTimeout(function() {
							messageDiv.textContent = '';
						}, 2000);
					}
				} catch (error) {
					messageDiv.textContent = 'Vehicle number already exists in database';
					messageDiv.style.color = 'red';
					setTimeout(function() {
							messageDiv.textContent = '';
						}, 2000);
				}

			});

		});

		function getTodayDateString() {
			const today = new Date();
			return today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
		}

		function updateVehicleCountDisplay() {
			const today = getTodayDateString();
			const recordedDate = localStorage.getItem('recordedDate');
			let count = parseInt(localStorage.getItem('vehicleCount'), 10);

			if (!recordedDate || recordedDate !== today || isNaN(count)) {
				// If it's a new day or the count isn't set, reset the count
				count = 0;
				localStorage.setItem('recordedDate', today);
				localStorage.setItem('vehicleCount', count);
			}

			document.getElementById('todayVehicleCount').textContent = `Today's recorded vehicles: ${count}`;
		}

		function incrementVehicleCount() {
			const count = parseInt(localStorage.getItem('vehicleCount'), 10) + 1;
			localStorage.setItem('vehicleCount', count);
			document.getElementById('todayVehicleCount').textContent = `Today's recorded vehicles: ${count}`;
		}



		document.getElementById('searchPageButton').addEventListener('click', () => {
            document.getElementById('searchPageButton').style.display = 'none';
            document.getElementById('vehicleForm').style.display = 'none';
            document.getElementById('searchVehicleForm').style.display = 'block';
        });

		// search code to search vehicles
		document.getElementById('searchSubmitButton').addEventListener('click', async () => {
			console.log("I came here!")
			const vehicleNumber = document.getElementById('searchVehicleNumber').value.trim();
			console.log(vehicleNumber)
			const searchResultsDiv = document.getElementById('searchResults');

			// Clear previous search results
			searchResultsDiv.innerHTML = '';

			if (vehicleNumber) {
				const vehiclesRef = collection(db, "vehicles");
				const q = query(vehiclesRef, where("vehicle_number", "==", vehicleNumber));
				const querySnapshot = await getDocs(q);

				if (!querySnapshot.empty) {
					
					querySnapshot.forEach((doc) => {
						const vehicle = doc.data();
						const subscriberIcon = vehicle.subscriber ? '&#10003;' : '&#10007;';
						const vehicleDetails = `
							<div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd;">
								<p><strong>Customer Name:</strong> ${vehicle.name}</p>
								<p><strong>Phone Number:</strong> ${vehicle.phone_number}</p>
								<p><strong>Vehicle Number:</strong> ${vehicle.vehicle_number}</p>
								<p><strong>Subscriber:</strong> ${subscriberIcon}</p>
								<p><strong>Last washed on:</strong> ${vehicle.date}</p>
							</div>
						`;
						searchResultsDiv.innerHTML += vehicleDetails;
					});
				} else {
					searchResultsDiv.innerHTML = 'No vehicle found with the provided number.';
				}
			} else {
				searchResultsDiv.innerHTML = 'Please enter a vehicle number to search.';
			}
		});



		document.getElementById('goBackButton').addEventListener('click', () => {
            document.getElementById('vehicleForm').style.display = 'block';

			document.getElementById('searchPageButton').style.display = 'inline-block';

            
			document.getElementById('searchVehicleForm').style.display = 'none';
			
			// Clear any search results
			document.getElementById('searchResults').innerHTML = '';
    
			// Also, make sure the search vehicle input is cleared to reset the form completely
			document.getElementById('searchVehicleNumber').value = '';
        });


	</script>

	<script>
		if ('serviceWorker' in navigator) {
		window.addEventListener('load', () => {
			navigator.serviceWorker.register('/service-worker.js')
			.then(reg => console.log('Service Worker Registered', reg))
			.catch(err => console.log('Service Worker Registration Failed', err));
		});
		}
	</script>
</body>

</html>
